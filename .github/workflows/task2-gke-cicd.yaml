name: "Task2 CI/CD - Frontend and Paymentservice"

on:
  push:
    branches:
      - main
    paths:
      - "src/frontend/**"
      - "src/paymentservice/**"
      - ".github/workflows/task2-gke-cicd.yaml"
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Deployment target environment"
        required: true
        type: choice
        default: staging
        options:
          - staging
          - production

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: "flash-aviary-488614-c1"
  GKE_CLUSTER_NAME: "online-boutique"
  GKE_CLUSTER_LOCATION: "us-central1-a"
  GCP_ARTIFACT_REGION: "us-central1"
  AR_REPOSITORY: "online-boutique"

jobs:
  build-and-push:
    name: "Build and Push Images"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image-meta.outputs.image_tag }}
      frontend_image: ${{ steps.image-meta.outputs.frontend_image }}
      paymentservice_image: ${{ steps.image-meta.outputs.paymentservice_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${GCP_ARTIFACT_REGION}-docker.pkg.dev" --quiet

      - name: Ensure Artifact Registry repository exists
        run: |
          set -euo pipefail
          if ! gcloud artifacts repositories describe "${AR_REPOSITORY}" \
            --location "${GCP_ARTIFACT_REGION}" > /dev/null 2>&1; then
            gcloud artifacts repositories create "${AR_REPOSITORY}" \
              --repository-format=docker \
              --location "${GCP_ARTIFACT_REGION}" \
              --description="Container images for microservices-demo Task 2"
          fi

      - name: Compute image names
        id: image-meta
        run: |
          set -euo pipefail
          IMAGE_TAG="${GITHUB_SHA::12}"
          FRONTEND_IMAGE="${GCP_ARTIFACT_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPOSITORY}/frontend:${IMAGE_TAG}"
          PAYMENTSERVICE_IMAGE="${GCP_ARTIFACT_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPOSITORY}/paymentservice:${IMAGE_TAG}"

          echo "image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "frontend_image=${FRONTEND_IMAGE}" >> "${GITHUB_OUTPUT}"
          echo "paymentservice_image=${PAYMENTSERVICE_IMAGE}" >> "${GITHUB_OUTPUT}"

      - name: Build and push frontend image
        run: |
          set -euo pipefail
          docker build \
            --file src/frontend/Dockerfile \
            --tag "${{ steps.image-meta.outputs.frontend_image }}" \
            src/frontend
          docker push "${{ steps.image-meta.outputs.frontend_image }}"

      - name: Build and push paymentservice image
        run: |
          set -euo pipefail
          docker build \
            --file src/paymentservice/Dockerfile \
            --tag "${{ steps.image-meta.outputs.paymentservice_image }}" \
            src/paymentservice
          docker push "${{ steps.image-meta.outputs.paymentservice_image }}"

  deploy-staging:
    name: "Deploy to Staging"
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'staging')
    environment: staging
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_CLUSTER_LOCATION }}

      - name: Update frontend and paymentservice in staging
        run: |
          set -euo pipefail
          kubectl -n staging set image deployment/frontend server="${{ needs.build-and-push.outputs.frontend_image }}"
          kubectl -n staging rollout status deployment/frontend --timeout=20m
          kubectl -n staging set image deployment/paymentservice server="${{ needs.build-and-push.outputs.paymentservice_image }}"
          kubectl -n staging rollout status deployment/paymentservice --timeout=20m

      - name: Debug staging rollout failure
        if: failure()
        run: |
          kubectl -n staging get deploy,pods -o wide
          kubectl -n staging get events --sort-by=.lastTimestamp | tail -n 120

      - name: Deployment summary
        run: |
          {
            echo "## Staging Deployment"
            echo ""
            echo "- frontend: \`${{ needs.build-and-push.outputs.frontend_image }}\`"
            echo "- paymentservice: \`${{ needs.build-and-push.outputs.paymentservice_image }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

  deploy-production:
    name: "Deploy to Production"
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'production'
    environment: production
    steps:
      - name: Ensure production deploy runs from main
        run: |
          if [[ "${GITHUB_REF_NAME}" != "main" ]]; then
            echo "Production deployments are only allowed from main branch."
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_CLUSTER_LOCATION }}

      - name: Update frontend and paymentservice in production
        run: |
          set -euo pipefail
          kubectl -n production set image deployment/frontend server="${{ needs.build-and-push.outputs.frontend_image }}"
          kubectl -n production rollout status deployment/frontend --timeout=20m
          kubectl -n production set image deployment/paymentservice server="${{ needs.build-and-push.outputs.paymentservice_image }}"
          kubectl -n production rollout status deployment/paymentservice --timeout=20m

      - name: Debug production rollout failure
        if: failure()
        run: |
          kubectl -n production get deploy,pods -o wide
          kubectl -n production get events --sort-by=.lastTimestamp | tail -n 120

      - name: Deployment summary
        run: |
          {
            echo "## Production Deployment"
            echo ""
            echo "- frontend: \`${{ needs.build-and-push.outputs.frontend_image }}\`"
            echo "- paymentservice: \`${{ needs.build-and-push.outputs.paymentservice_image }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"
